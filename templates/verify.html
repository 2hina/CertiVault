{% extends "layout.html" %}

{% block title %}Verify Certificate - CertiVault{% endblock %}

{% block content %}
<div class="verify-container">
    <h1><i class="fas fa-check-circle"></i> Verify Certificate Authenticity</h1>
    <p class="subtitle">Check if an academic certificate is genuine using multiple verification methods</p>

    <div class="verification-methods">
        <div class="method-tabs">
            <button class="method-tab active" data-method="hash">
                <i class="fas fa-hashtag"></i> Verify by Hash
            </button>
            <button class="method-tab" data-method="upload">
                <i class="fas fa-upload"></i> Verify by Upload
            </button>
            <button class="method-tab" data-method="qr">
                <i class="fas fa-qrcode"></i> Verify by QR Code
            </button>
        </div>

        <div class="method-content">
            <!-- Hash Verification -->
            <div class="method-form active" id="hashForm">
                <form method="POST" class="verify-form">
                    <input type="hidden" name="verification_method" value="hash">
                    <div class="form-group">
                        <label for="certificate_hash"><i class="fas fa-fingerprint"></i> Certificate Hash</label>
                        <input type="text" id="certificate_hash" name="certificate_hash" 
                               placeholder="Enter the 64-character SHA-256 hash" required
                               pattern="[A-Fa-f0-9]{64}">
                        <small>Enter the complete 64-character hexadecimal hash</small>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search"></i> Verify Hash
                    </button>
                </form>
            </div>

            <!-- Upload Verification -->
            <div class="method-form" id="uploadForm">
                <form method="POST" enctype="multipart/form-data" class="verify-form">
                    <input type="hidden" name="verification_method" value="upload">
                    <div class="form-group">
                        <label for="certificate_file"><i class="fas fa-file-upload"></i> Upload Certificate</label>
                        <div class="file-upload-area upload-area">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop certificate file or <span>browse</span></p>
                            <p class="file-types">Supported: PNG, JPG, JPEG, PDF</p>
                            <input type="file" id="certificate_file" name="certificate" 
                                   accept=".png,.jpg,.jpeg,.pdf" required>
                        </div>
                        <div id="uploadFileName"></div>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-shield-check"></i> Verify Upload
                    </button>
                </form>
            </div>

            <!-- QR Verification -->
            <div class="method-form" id="qrForm">
                <div class="qr-verification">
                    <div class="qr-scanner-placeholder">
                        <i class="fas fa-qrcode"></i>
                        <h3>QR Code Scanner</h3>
                        <p>Point your camera at the certificate QR code</p>
                        <button class="btn btn-secondary" onclick="startScanner()">
                            <i class="fas fa-camera"></i> Start Scanner
                        </button>
                    </div>
                    <div class="qr-result" id="qrResult"></div>
                </div>
            </div>
        </div>
    </div>

    {% if found is defined %}
    <div class="verification-result">
        {% if found %}
        <div class="result-success">
            <div class="result-header">
                <i class="fas fa-check-circle"></i>
                <h2>Certificate Verified Successfully!</h2>
            </div>
            <div class="result-details">
                <div class="result-card">
                    <h3><i class="fas fa-shield-alt"></i> Verification Status</h3>
                    <div class="status-badge authentic">
                        <i class="fas fa-check"></i> AUTHENTIC
                    </div>
                    <p>This certificate is verified and tamper-proof</p>
                </div>
                
                <div class="result-card">
                    <h3><i class="fas fa-certificate"></i> Certificate Details</h3>
                    <div class="details-grid">
                        <div class="detail">
                            <span class="label">Issuer:</span>
                            <span class="value">{{ certificate.issuer }}</span>
                        </div>
                        <div class="detail">
                            <span class="label">Recipient:</span>
                            <span class="value">{{ certificate.recipient }}</span>
                        </div>
                        <div class="detail">
                            <span class="label">Issue Date:</span>
                            <span class="value">{{ certificate.issue_date }}</span>
                        </div>
                        <div class="detail">
                            <span class="label">Certificate Hash:</span>
                            <code class="hash-value">{{ certificate.hash }}</code>
                        </div>
                    </div>
                </div>
                
                <div class="result-card">
                    <h3><i class="fas fa-qrcode"></i> Quick Verification</h3>
                    <div class="verification-actions">
                        <a href="{{ url_for('generate_qr', hash_value=certificate.hash) }}" 
                           class="btn btn-small">
                            <i class="fas fa-qrcode"></i> Generate QR Code
                        </a>
                        <a href="{{ url_for('api_verify', hash_value=certificate.hash) }}" 
                           target="_blank" class="btn btn-small">
                            <i class="fas fa-code"></i> API Response
                        </a>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="result-error">
            <div class="result-header">
                <i class="fas fa-times-circle"></i>
                <h2>Certificate Not Verified</h2>
            </div>
            <p class="error-message">{{ message }}</p>
            <div class="error-suggestions">
                <h4>Possible Reasons:</h4>
                <ul>
                    <li>Certificate hash doesn't exist in our database</li>
                    <li>Certificate has been tampered with</li>
                    <li>Certificate was not issued through CertiVault</li>
                    <li>Incorrect hash or file uploaded</li>
                </ul>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <div class="verification-info">
        <h3><i class="fas fa-info-circle"></i> How Verification Works</h3>
        <div class="info-cards">
            <div class="info-card">
                <i class="fas fa-hashtag"></i>
                <h4>Hash Matching</h4>
                <p>Compare uploaded file hash with stored hash in blockchain database</p>
            </div>
            <div class="info-card">
                <i class="fas fa-signature"></i>
                <h4>Digital Signature</h4>
                <p>Validate issuer's digital signature for authenticity verification</p>
            </div>
            <div class="info-card">
                <i class="fas fa-unlink"></i>
                <h4>Tamper Detection</h4>
                <p>Any modification to certificate changes hash, making tampering detectable</p>
            </div>
            <div class="info-card">
                <i class="fas fa-bolt"></i>
                <h4>Instant Results</h4>
                <p>Get verification results in seconds with detailed certificate information</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('.method-tab');
    const forms = document.querySelectorAll('.method-form');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const method = this.dataset.method;
            
            // Update tabs
            tabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Update forms
            forms.forEach(form => form.classList.remove('active'));
            document.getElementById(`${method}Form`).classList.add('active');
        });
    });

    // File upload for verification
    const uploadArea = document.querySelector('.upload-area');
    const fileInput = document.querySelector('#certificate_file');
    const fileName = document.getElementById('uploadFileName');

    if (uploadArea) {
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            fileInput.files = e.dataTransfer.files;
            updateFileName();
        });

        fileInput.addEventListener('change', updateFileName);

        function updateFileName() {
            if (fileInput.files.length > 0) {
                fileName.textContent = `Selected: ${fileInput.files[0].name}`;
                fileName.style.display = 'block';
            }
        }
    }
});

function startScanner() {
    alert('QR Scanner would be implemented with a library like Instascan.js in production');
    // Implementation for QR scanner would go here
    // You would use a library like Instascan.js
}
</script>
{% endblock %}